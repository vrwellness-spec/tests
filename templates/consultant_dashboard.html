
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consultant Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <h1>Consultant Dashboard</h1>
        <p>Welcome, {{ session['username'] }}! | <a href="/logout">Logout</a></p>

        <div class="tab-nav">
            <button class="tab-link active" onclick="openTab(event, 'clients')">My Clients</button>
            <button class="tab-link" onclick="openTab(event, 'add_client')">Add New Client</button>
        </div>

        <!-- My Clients Tab -->
        <div id="clients" class="tab-content" style="display: block;">
            <h2>My Clients</h2>
            <button id="refresh-clients-btn" class="btn btn-primary">Refresh List</button>
            <table id="clients-table">
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Client list will be loaded here -->
                </tbody>
            </table>
        </div>

        <!-- Add New Client Tab -->
        <div id="add_client" class="tab-content">
            <h2>Add a New Client</h2>
            <form id="add-client-form">
                <div class="form-group">
                    <label for="username">Client Username</label>
                    <input type="text" id="username" name="username" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="email">Client Email</label>
                    <input type="email" id="email" name="email" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="phone">Client Phone</label>
                    <input type="tel" id="phone" name="phone" class="form-control" required>
                </div>
                <button type="submit" class="btn btn-primary">Create Client & Get Link</button>
            </form>
            <div id="new-client-info" style="display:none; margin-top: 1rem;" class="alert alert-success">
                <h4>Client Created!</h4>
                <p>Please send the following unique assessment link to your client.</p>
                <p><strong>Assessment Link:</strong> <input type="text" id="new-client-link" class="form-control" readonly></p>
                <button id="copy-invite-link-btn" class="btn btn-secondary">Copy Link</button>
            </div>
        </div>

    </div>

    <script>
        function openTab(evt, tabName) {
            let i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tab-link");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
        }

        document.addEventListener('DOMContentLoaded', () => {
            const clientsTableBody = document.querySelector('#clients-table tbody');
            const refreshClientsBtn = document.getElementById('refresh-clients-btn');
            const addClientForm = document.getElementById('add-client-form');
            const newClientInfo = document.getElementById('new-client-info');
            const newClientLinkInput = document.getElementById('new-client-link');
            const copyInviteLinkBtn = document.getElementById('copy-invite-link-btn');

            async function fetchClients() {
                try {
                    const response = await fetch("/api/consultant/patients");
                    const patients = await response.json();
                    clientsTableBody.innerHTML = '';
                    if (patients.length === 0) {
                        clientsTableBody.innerHTML = '<tr><td colspan="4">You have not added any clients yet.</td></tr>';
                        return;
                    }
                    patients.forEach(patient => {
                        const row = document.createElement('tr');
                        const latestResultLink = patient.latest_session_id 
                            ? `<a href="/results/${patient.latest_session_id}" class="btn btn-primary btn-sm">View Latest</a>`
                            : `<button class="btn btn-secondary btn-sm" disabled>No Results</button>`;
                        const assessmentUrl = `${window.location.origin}/?patient_id=${patient.id}`;

                        row.innerHTML = `
                            <td>${patient.username}</td>
                            <td>${patient.email || 'N/A'}</td>
                            <td>${patient.phone || 'N/A'}</td>
                            <td>
                                ${latestResultLink}
                                <button class="btn btn-secondary btn-sm copy-link-btn" data-link="${assessmentUrl}">Copy Test Link</button>
                            </td>
                        `;
                        clientsTableBody.appendChild(row);
                    });
                } catch (error) {
                    clientsTableBody.innerHTML = '<tr><td colspan="4">Error loading clients.</td></tr>';
                }
            }

            addClientForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const username = e.target.elements.username.value;
                const email = e.target.elements.email.value;
                const phone = e.target.elements.phone.value;
                try {
                    const response = await fetch("/api/consultant/add_patient", {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, email, phone })
                    });
                    const result = await response.json();
                    if (response.ok) {
                        const assessmentLink = `${window.location.origin}/?patient_id=${result.patient_id}`;
                        newClientLinkInput.value = assessmentLink;
                        newClientInfo.style.display = 'block';
                        addClientForm.reset();
                        fetchClients();
                    } else {
                        alert(`Error: ${result.error}`);
                    }
                } catch (error) {
                    alert('An unexpected error occurred.');
                }
            });

            clientsTableBody.addEventListener('click', (e) => {
                if (e.target.classList.contains('copy-link-btn')) {
                    const link = e.target.dataset.link;
                    navigator.clipboard.writeText(link).then(() => {
                        alert('Assessment link copied to clipboard!');
                    }, () => {
                        alert('Failed to copy link.');
                    });
                }
            });

            copyInviteLinkBtn.addEventListener('click', () => {
                newClientLinkInput.select();
                navigator.clipboard.writeText(newClientLinkInput.value).then(() => {
                    alert('Assessment link copied to clipboard!');
                });
            });

            refreshClientsBtn.addEventListener('click', fetchClients);

            // Initial Load
            fetchClients();
        });
    </script>
</body>
</html>
